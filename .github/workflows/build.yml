name: build

on:
  push:
    # ä»…åœ¨ main åˆ†æ”¯æ¨é€æ—¶è§¦å‘
    branches:
      - main
  workflow_dispatch:
  schedule:
    # æ¯å¤© UTC 0:00 è¿è¡Œä¸€æ¬¡ (åŒ—äº¬æ—¶é—´æ—©ä¸Š 8 ç‚¹)
    - cron: "0 0 */1 * *"

jobs:
  build:
    runs-on: ubuntu-latest
    
    # ğŸ“Œ è§£å†³ 403 é”™è¯¯çš„å¿…è¦é…ç½®ï¼šæˆäºˆå†…ç½® GITHUB_TOKEN å†™å…¥ä»“åº“å†…å®¹çš„æƒé™
    permissions:
      contents: write 
      
    steps:
      - name: Check out repo
        # æ¨èä½¿ç”¨æœ€æ–°çš„ checkout action
        uses: actions/checkout@v4
        
      - name: Set up Python
        # æ¨èä½¿ç”¨æœ€æ–°çš„ setup-python action
        uses: actions/setup-python@v5
        with:
          python-version: 3.8
          
      - uses: actions/cache@v4
        name: Configure pip caching
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
            
      - name: Install Python dependencies
        run: |
          python -m pip install -r requirements.txt
          
      - name: Update README
        env:
          # GH_TOKEN æ˜¯æ‚¨ç”¨äº GraphQL èº«ä»½éªŒè¯çš„ PAT Secret
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |-
          python build_readme.py
          # æ­¤å¤„å·²æ‰“å° README.md å†…å®¹
          cat README.md
          
      - name: Commit and push if changed
        run: |-
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŒ–
          git diff
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add -A
          # åªæœ‰åœ¨æœ‰æ–‡ä»¶å˜åŒ–æ—¶æ‰åˆ›å»ºæäº¤ï¼Œé˜²æ­¢ç©ºæäº¤
          git commit -m "ci: update profile (automatically)" || exit 0
          # ä½¿ç”¨ GITHUB_TOKEN (æ‹¥æœ‰ contents: write æƒé™) æ¨é€æ›´æ”¹
          git push
          
          # ğŸ“¢ æŒ‰æ‚¨çš„è¦æ±‚ï¼Œåœ¨æœ€åä¸€æ­¥å†æ¬¡æ‰“å° README.md
          echo "--- Final README.md Content After Push ---"
          cat README.md